<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Email Scraper</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-3xl font-bold mb-8">ðŸ“§ Website Email Scraper</h1>

      <div class="bg-white rounded-lg shadow p-6 mb-8">
        <p class="mb-4">
          Enter website URLs (one per line) to scrape emails from:
        </p>
        <textarea
          id="urls"
          class="w-full h-40 p-2 border rounded mb-4"
          placeholder="example.com&#10;another-example.com"
        ></textarea>
        <button
          onclick="scrapeEmails()"
          class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
          id="scrapeButton"
        >
          Start Scraping
        </button>
      </div>

      <div id="loading" class="hidden">
        <div class="bg-white rounded-lg shadow p-6 mb-8">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-2">
              <div
                class="animate-spin h-8 w-8 border-4 border-blue-500 rounded-full border-t-transparent"
              ></div>
              <span>Scraping emails...</span>
            </div>
            <button
              onclick="cancelScraping()"
              class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"
            >
              Cancel
            </button>
          </div>

          <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
            <div
              id="progressBar"
              class="bg-blue-600 h-2.5 rounded-full"
              style="width: 0%"
            ></div>
          </div>

          <div id="progressStatus" class="text-sm text-gray-600">
            Processing website 0 of 0
          </div>

          <div id="currentUrl" class="text-sm text-gray-600 mt-2"></div>
        </div>
      </div>

      <div id="errors" class="hidden mb-8">
        <h2 class="text-xl font-semibold mb-4">Errors</h2>
        <div id="errorsList" class="space-y-2"></div>
      </div>

      <div id="results" class="hidden">
        <div
          id="summary"
          class="bg-green-50 border border-green-200 rounded-lg p-4 mb-8"
        >
          <!-- Summary will be inserted here -->
        </div>

        <div class="bg-white rounded-lg shadow overflow-hidden">
          <table class="min-w-full">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Website
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Email
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Source Page
                </th>
              </tr>
            </thead>
            <tbody id="emailsList" class="bg-white divide-y divide-gray-200">
              <!-- Results will be inserted here -->
            </tbody>
          </table>
        </div>

        <div class="mt-4">
          <button
            onclick="downloadCSV()"
            class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"
            id="downloadButton"
          >
            Download CSV
          </button>
        </div>
      </div>
    </div>

    <script>
      let scrapedData = null;
      let isCancelled = false;
      let currentRequest = null;

      function isValidUrl(url) {
        try {
          // Remove leading/trailing whitespace and common prefixes
          url = url.trim().toLowerCase();
          if (!url) return false;

          // Add protocol if missing
          if (!url.startsWith("http://") && !url.startsWith("https://")) {
            url = "https://" + url;
          }

          const urlObj = new URL(url);
          // Check for valid hostname (at least one dot)
          return urlObj.hostname.includes(".");
        } catch {
          return false;
        }
      }

      async function scrapeEmails(retryCount = 0) {
        const MAX_RETRIES = 2;
        const urlsText = document.getElementById("urls").value.trim();
        if (!urlsText) {
          alert("Please enter at least one URL");
          return;
        }

        // Process and validate URLs
        const urls = urlsText
          .split("\n")
          .map((url) => url.trim())
          .filter((url) => {
            if (!isValidUrl(url)) {
              console.warn(`Invalid URL skipped: ${url}`);
              return false;
            }
            return true;
          });

        if (urls.length === 0) {
          alert("Please enter at least one valid URL");
          return;
        }

        // Reset state
        isCancelled = false;
        document.getElementById("loading").classList.remove("hidden");
        document.getElementById("results").classList.add("hidden");
        document.getElementById("errors").classList.add("hidden");
        document.getElementById("scrapeButton").disabled = true;
        document.getElementById("progressBar").style.width = "0%";
        document.getElementById(
          "progressStatus"
        ).textContent = `Processing website 0 of ${urls.length}`;

        try {
          const controller = new AbortController();
          currentRequest = controller;

          const response = await fetch("/scrape", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ urls }),
            signal: controller.signal,
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.error || `HTTP error! status: ${response.status}`
            );
          }

          const data = await response.json();
          scrapedData = data;

          if (isCancelled) {
            return;
          }

          // Update progress to 100%
          document.getElementById("progressBar").style.width = "100%";
          document.getElementById(
            "progressStatus"
          ).textContent = `Completed processing ${urls.length} websites`;

          // Display summary with more details
          const summary = document.getElementById("summary");
          summary.innerHTML = `
            <div class="text-green-700">
              <p class="font-medium">Scraping Complete:</p>
              <ul class="list-disc list-inside ml-4 mt-2">
                <li>Found ${data.summary.total_emails_found} unique email(s)</li>
                <li>Successfully scraped ${data.summary.successful_scrapes} out of ${data.summary.total_websites_processed} websites</li>
              </ul>
            </div>
          `;

          // Display errors if any
          if (data.errors && data.errors.length > 0) {
            const errorsList = document.getElementById("errorsList");
            errorsList.innerHTML = data.errors
              .map(
                (error) => `
                  <div class="bg-red-50 border-l-4 border-red-400 p-4 flex justify-between items-center">
                    <p class="text-red-700">
                      <strong>${error.url}:</strong> ${error.error}
                    </p>
                    <button 
                      onclick="retryUrl('${error.url}')"
                      class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm"
                    >
                      Retry
                    </button>
                  </div>
                `
              )
              .join("");
            document.getElementById("errors").classList.remove("hidden");
          }

          // Display results
          const emailsList = document.getElementById("emailsList");
          emailsList.innerHTML = data.results
            .flatMap((result) =>
              result.email_data.map(
                (email) => `
                  <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${
                      result.url
                    }</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${
                      email.email
                    }</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      ${
                        email.source_page === result.url
                          ? "Main Page"
                          : email.source_page
                      }
                    </td>
                  </tr>
                `
              )
            )
            .join("");

          document.getElementById("results").classList.remove("hidden");
        } catch (error) {
          if (error.name === "AbortError") {
            console.log("Fetch aborted");
          } else {
            console.error("Error:", error);
            alert(
              error.message ||
                "An error occurred while scraping. Please try again."
            );
          }
        } finally {
          if (!isCancelled) {
            document.getElementById("loading").classList.add("hidden");
            document.getElementById("scrapeButton").disabled = false;
          }
          currentRequest = null;
        }
      }

      function cancelScraping() {
        if (currentRequest) {
          isCancelled = true;
          currentRequest.abort();
          document.getElementById("loading").classList.add("hidden");
          document.getElementById("scrapeButton").disabled = false;
        }
      }

      async function retryUrl(url) {
        const textarea = document.getElementById("urls");
        textarea.value = url;
        await scrapeEmails();
      }

      function downloadCSV() {
        if (!scrapedData || !scrapedData.results) return;

        const rows = [["Website", "Email", "Source Page"]];
        scrapedData.results.forEach((result) => {
          result.email_data.forEach((email) => {
            rows.push([
              result.url,
              email.email,
              email.source_page === result.url
                ? "Main Page"
                : email.source_page,
            ]);
          });
        });

        const csvContent = rows
          .map((row) =>
            row.map((cell) => `"${cell.replace(/"/g, '""')}"`).join(",")
          )
          .join("\n");

        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "scraped_emails.csv";
        link.click();
      }
    </script>
  </body>
</html>
